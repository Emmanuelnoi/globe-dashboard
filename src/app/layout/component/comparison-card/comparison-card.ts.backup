import { CommonModule } from '@angular/common';
import {
  AfterViewInit,
  Component,
  ElementRef,
  QueryList,
  ViewChildren,
  inject,
  signal,
  computed,
} from '@angular/core';
import { TableKeyboardDirective } from '@lib/directives/table-keyboard.directive';
import { CountryDataService } from '../../../core/services/country-data.service';
import { CountryDataRecord } from '../../../core/types/country-data.types';
import { CountrySearch } from '../country-search/country-search';

@Component({
  selector: 'app-comparison-card',
  imports: [CommonModule, TableKeyboardDirective, CountrySearch],
  template: `
    <section class="cmp-card centered-card" aria-labelledby="cmp-title">
      <header class="cmp-header">
        <h2 id="cmp-title">Country Statistics Comparison</h2>
        <div class="stats-summary">
          <span class="stats-item">
            <strong>{{ countryDataService.countryCount() }}</strong> countries
          </span>
          <span class="stats-item">
            <strong>{{ countryDataService.selectedCountries().length }}</strong>
            selected
          </span>
          @if (countryDataService.dataCompleteness() > 0) {
            <span class="stats-item">
              <strong
                >{{
                  (countryDataService.dataCompleteness() * 100).toFixed(1)
                }}%</strong
              >
              data completeness
            </span>
          }
        </div>

        <div class="controls" role="toolbar" aria-label="Table actions">
          <!-- Country Search Component -->
          <app-country-search [collapsed]="false"></app-country-search>

          <!-- Action buttons grouped together -->
          <div class="action-buttons">
            <!-- Compact Sort Control (Pattern A) -->
            <div class="sort-control" role="group" aria-label="Sort countries">
              <div class="sort-button-group">
                <!-- Main sort button with dropdown -->
                <button
                  class="sort-main-btn"
                  type="button"
                  (click)="toggleSortDropdown()"
                  [attr.aria-expanded]="showSortDropdown()"
                  aria-label="Select sort metric"
                >
                  <span class="sort-label">Sort by</span>
                  <span class="sort-metric">{{ getCurrentSortLabel() }}</span>
                  <svg class="dropdown-icon" width="12" height="12" viewBox="0 0 20 20" aria-hidden="true">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 8l4 4 4-4"/>
                  </svg>
                </button>

                <!-- Direction toggle button -->
                <button
                  class="sort-direction-btn"
                  type="button"
                  (click)="toggleSortDirection()"
                  [attr.aria-label]="'Sort ' + (sortDirection() === 'asc' ? 'ascending' : 'descending')"
                >
                  <svg class="direction-icon" width="12" height="12" viewBox="0 0 20 20" aria-hidden="true">
                    @if (sortDirection() === 'asc') {
                      <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 4l-4 4h8l-4-4z"/>
                    } @else {
                      <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 16l4-4H6l4 4z"/>
                    }
                  </svg>
                </button>
              </div>

              <!-- Dropdown menu -->
              @if (showSortDropdown()) {
                <div class="sort-dropdown-menu" role="menu">
                  <button
                    type="button"
                    class="sort-option"
                    [class.active]="sortMetric() === 'name'"
                    role="menuitem"
                    (click)="selectSortMetric('name')"
                  >
                    <span>Country Name</span>
                    @if (sortMetric() === 'name') {
                      <svg class="check-icon" width="16" height="16" viewBox="0 0 20 20" aria-hidden="true">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 10l2 2 6-6"/>
                      </svg>
                    }
                  </button>
                  <button
                    type="button"
                    class="sort-option"
                    [class.active]="sortMetric() === 'hdi'"
                    role="menuitem"
                    (click)="selectSortMetric('hdi')"
                  >
                    <span>HDI</span>
                    @if (sortMetric() === 'hdi') {
                      <svg class="check-icon" width="16" height="16" viewBox="0 0 20 20" aria-hidden="true">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 10l2 2 6-6"/>
                      </svg>
                    }
                  </button>
                  <button
                    type="button"
                    class="sort-option"
                    [class.active]="sortMetric() === 'gdp'"
                    role="menuitem"
                    (click)="selectSortMetric('gdp')"
                  >
                    <span>GDP per Capita</span>
                    @if (sortMetric() === 'gdp') {
                      <svg class="check-icon" width="16" height="16" viewBox="0 0 20 20" aria-hidden="true">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 10l2 2 6-6"/>
                      </svg>
                    }
                  </button>
                  <button
                    type="button"
                    class="sort-option"
                    [class.active]="sortMetric() === 'population'"
                    role="menuitem"
                    (click)="selectSortMetric('population')"
                  >
                    <span>Population</span>
                    @if (sortMetric() === 'population') {
                      <svg class="check-icon" width="16" height="16" viewBox="0 0 20 20" aria-hidden="true">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 10l2 2 6-6"/>
                      </svg>
                    }
                  </button>
                  <button
                    type="button"
                    class="sort-option"
                    [class.active]="sortMetric() === 'lifeExpectancy'"
                    role="menuitem"
                    (click)="selectSortMetric('lifeExpectancy')"
                  >
                    <span>Life Expectancy</span>
                    @if (sortMetric() === 'lifeExpectancy') {
                      <svg class="check-icon" width="16" height="16" viewBox="0 0 20 20" aria-hidden="true">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 10l2 2 6-6"/>
                      </svg>
                    }
                  </button>
                  <button
                    type="button"
                    class="sort-option"
                    [class.active]="sortMetric() === 'happiness'"
                    role="menuitem"
                    (click)="selectSortMetric('happiness')"
                  >
                    <span>Happiness Index</span>
                    @if (sortMetric() === 'happiness') {
                      <svg class="check-icon" width="16" height="16" viewBox="0 0 20 20" aria-hidden="true">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 10l2 2 6-6"/>
                      </svg>
                    }
                  </button>
                </div>
              }
            </div>

            <button
              class="btn ghost"
              type="button"
              (click)="onClearAll()"
              aria-label="Clear all filters"
            >
              Clear All
            </button>

            <button
              class="btn primary"
              type="button"
              (click)="onExportCSV()"
              aria-label="Export CSV"
              [disabled]="!countryDataService.hasSelectedCountries()"
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                aria-hidden="true"
              >
                <path
                  d="M12 3v12"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  fill="none"
                />
                <path
                  d="M8 11l4 4 4-4"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  fill="none"
                />
                <path
                  d="M21 21H3"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  fill="none"
                />
              </svg>
              <span>Export CSV</span>
            </button>
          </div>
        </div>
      </header>

      <!-- glass wrapper: fixed header + scrollable body inside this wrapper -->
      <div
        class="glass-table-wrapper"
        role="region"
        aria-label="Country comparison table"
        [appTableKeyboard]="displayedCountries().length"
        [(focusedIndex)]="_focusedIndex"
        (navigate)="focusRow($event)"
        (activate)="toggleRowSelection($event)"
      >
        <table
          class="cmp-table"
          role="table"
          aria-describedby="cmp-title"
          tabindex="0"
        >
          <thead role="rowgroup">
            <tr role="row">
              <th scope="col">Country</th>
              <th scope="col">Code</th>
              <th scope="col">Capital</th>
              <th scope="col">Region</th>
              <th scope="col">GDP per Capita</th>
              <th scope="col">HDI</th>
              <th scope="col" class="highlighted">Population</th>
              <th scope="col">Life Expectancy</th>
              <th scope="col">Happiness Index</th>
              <th scope="col" class="actions-col" aria-hidden="true">
                Actions
              </th>
            </tr>
          </thead>

          <tbody role="rowgroup">
            @for (
              country of displayedCountries();
              let i = $index;
              track trackByCode(i, country)
            ) {
              <tr
                #rowItem
                role="row"
                class="data-row"
                [attr.data-code]="country.code"
                [attr.tabindex]="i === focusedIndex() ? 0 : -1"
                [attr.aria-selected]="isSelected(country.code)"
                (click)="toggleRowSelection(i)"
              >
                <td role="cell" class="country-cell">
                  <a
                    class="country-link"
                    href="#"
                    (click)="
                      $event.preventDefault(); selectCountry(country.code)
                    "
                  >
                    <span class="country-name">{{ country.name }}</span>
                  </a>
                </td>

                <td role="cell">
                  <span class="code-pill">{{ country.code }}</span>
                </td>

                <td role="cell">{{ country.capital }}</td>
                <td role="cell">
                  <span class="region-badge">{{ country.region }}</span>
                </td>

                <td role="cell">
                  <span class="gdp-value">{{
                    country.gdpPerCapitaFormatted
                  }}</span>
                </td>

                <td role="cell">
                  <span class="hdi-value">{{ country.hdiFormatted }}</span>
                  @if (country.hdiCategory) {
                    <span
                      class="hdi-badge"
                      [attr.data-category]="country.hdiCategory"
                    >
                      {{ country.hdiCategory }}
                    </span>
                  }
                </td>

                <td role="cell" class="population-cell">
                  <strong>{{ country.populationFormatted }}</strong>
                </td>

                <td role="cell">
                  <span class="life-expectancy">{{
                    country.lifeExpectancyFormatted
                  }}</span>
                </td>

                <td role="cell">
                  <span class="heart" aria-hidden="true">❤</span>
                  <span class="happiness-value">{{
                    country.happinessFormatted
                  }}</span>
                </td>

                <td role="cell" class="actions-col">
                  <button
                    class="icon-btn"
                    [attr.aria-label]="'Remove ' + country.name"
                    (click)="
                      removeCountry(country.code); $event.stopPropagation()
                    "
                  >
                    <svg
                      width="14"
                      height="14"
                      viewBox="0 0 24 24"
                      aria-hidden="true"
                    >
                      <path
                        d="M18 6L6 18M6 6l12 12"
                        stroke="currentColor"
                        stroke-width="1.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        fill="none"
                      />
                    </svg>
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>

        <!-- Empty state -->
        @if (displayedCountries().length === 0) {
          <div class="empty-state">
            <div class="empty-content">
              <h3>No countries selected</h3>
              <p>
                Use the search above to find and select countries for
                comparison.
              </p>
            </div>
          </div>
        }
      </div>
    </section>
  `, // Updated template
  styles: [
    `
      :host {
        --page-side-padding: 36px;
        --page-bottom-padding: 20px;
        --content-max-width: 1400px;
        --card-radius: 14px;

        --cmp-glass-bg-1: rgba(255, 255, 255, 0.06);
        --cmp-glass-bg-2: rgba(255, 255, 255, 0.02);
        --muted: rgba(255, 255, 255, 0.85);

        --row-height: 56px;
        --visible-rows: 4;
        --table-header-height: 56px;

        display: block;
        font-family:
          Inter,
          system-ui,
          -apple-system,
          'Segoe UI',
          Roboto,
          'Helvetica Neue',
          Arial;
      }

      /* ------------------ CENTERED, WIDER, LOWER card ------------------ */
      .cmp-card.centered-card {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: var(--page-bottom-padding);
        width: min(96vw, var(--content-max-width));
        max-width: var(--content-max-width);
        z-index: 120;
        pointer-events: auto;
        box-sizing: border-box;

        border-radius: var(--card-radius);
        padding: 16px 20px;
        background: linear-gradient(
          180deg,
          var(--cmp-glass-bg-1),
          var(--cmp-glass-bg-2)
        );
        border: 1px solid rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(14px) saturate(1.15);
        -webkit-backdrop-filter: blur(14px) saturate(1.15);
        box-shadow:
          0 18px 40px rgba(0, 0, 0, 0.45),
          inset 0 1px 0 rgba(255, 255, 255, 0.02);
      }

      /* header + controls */
      .cmp-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 14px;
        flex-wrap: wrap;
      }

      .cmp-header h2 {
        margin: 0;
        font-weight: 600;
        font-size: 20px;
        color: var(--muted);
      }

      .stats-summary {
        display: flex;
        gap: 16px;
        align-items: center;
        font-size: 13px;
        color: rgba(255, 255, 255, 0.7);
      }

      .stats-item {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .stats-item strong {
        color: rgba(255, 255, 255, 0.9);
      }

      .controls {
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
        flex-wrap: nowrap;
        min-height: 44px;
      }

      .controls app-country-search {
        flex: 1;
        min-width: 280px;
        max-width: 400px;
        display: flex;
        align-items: center;
      }

      .action-buttons {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-shrink: 0;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 9px 14px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.04),
          rgba(255, 255, 255, 0.01)
        );
        backdrop-filter: blur(12px) saturate(1.1);
        -webkit-backdrop-filter: blur(12px) saturate(1.1);
        box-shadow:
          0 8px 20px rgba(0, 0, 0, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.03);
        color: var(--muted);
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition:
          transform 150ms ease,
          box-shadow 150ms ease,
          color 150ms ease;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn:not(:disabled):hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.55);
        color: rgba(255, 255, 255, 0.95);
      }

      .btn.primary {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.05),
          rgba(255, 255, 255, 0.02)
        );
        border-color: rgba(255, 255, 255, 0.15);
        color: #fff;
      }

      .btn.ghost {
        background: transparent;
        border-color: rgba(255, 255, 255, 0.06);
      }

      .search {
        padding: 9px 12px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(255, 255, 255, 0.03);
        color: var(--muted);
        min-width: 200px;
        font-size: 14px;
      }

      .search::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }

      /* ------------------ GLASS TABLE WITH STICKY HEADER ------------------ */
      .glass-table-wrapper {
        border-radius: 12px;
        padding: 10px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.03),
          rgba(255, 255, 255, 0)
        );
        border: 1px solid rgba(255, 255, 255, 0.06);
        max-height: calc(
          var(--table-header-height) +
            (var(--row-height) * var(--visible-rows)) + 12px
        );
        overflow-y: auto;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        position: relative;
      }

      .cmp-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 1100px;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.92);
        table-layout: fixed;
      }

      thead th {
        text-align: left;
        padding: 14px 16px;
        font-weight: 600;
        font-size: 13px;
        color: rgba(255, 255, 255, 0.85);
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);

        position: sticky;
        top: 0;
        z-index: 115;
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0.6),
          rgba(0, 0, 0, 0.4)
        );
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
      }

      tbody tr {
        transition:
          background 0.15s ease,
          transform 0.15s ease;
      }

      tbody tr:nth-child(odd) {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.015),
          transparent
        );
      }

      tbody td {
        padding: 12px 16px;
        vertical-align: middle;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        height: var(--row-height);
        box-sizing: border-box;
      }

      .data-row[aria-selected='true'] {
        background: linear-gradient(
          180deg,
          rgba(25, 184, 148, 0.08),
          rgba(25, 184, 148, 0.02)
        );
        box-shadow: inset 0 1px 0 rgba(25, 184, 148, 0.1);
      }

      .data-row:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(25, 184, 148, 0.3);
      }

      .country-cell .country-link {
        text-decoration: none;
        color: #19b894;
        font-weight: 600;
        transition: color 0.15s ease;
      }

      .country-cell .country-link:hover {
        color: #20c9a6;
      }

      .code-pill {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.05);
        color: rgba(255, 255, 255, 0.9);
        font-size: 11px;
        font-weight: 600;
        border: 1px solid rgba(255, 255, 255, 0.04);
      }

      .region-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 6px;
        background: rgba(100, 149, 237, 0.1);
        color: #6495ed;
        font-size: 11px;
        font-weight: 500;
        border: 1px solid rgba(100, 149, 237, 0.2);
      }

      .hdi-badge {
        display: inline-block;
        padding: 3px 7px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 10px;
        margin-left: 8px;
        text-transform: uppercase;
      }

      .hdi-badge[data-category='Very High'] {
        background: rgba(20, 200, 120, 0.12);
        color: #14c878;
        border: 1px solid rgba(20, 200, 120, 0.2);
      }

      .hdi-badge[data-category='High'] {
        background: rgba(255, 193, 7, 0.12);
        color: #ffc107;
        border: 1px solid rgba(255, 193, 7, 0.2);
      }

      .hdi-badge[data-category='Medium'] {
        background: rgba(255, 152, 0, 0.12);
        color: #ff9800;
        border: 1px solid rgba(255, 152, 0, 0.2);
      }

      .hdi-badge[data-category='Low'] {
        background: rgba(244, 67, 54, 0.12);
        color: #f44336;
        border: 1px solid rgba(244, 67, 54, 0.2);
      }

      .population-cell {
        color: rgba(255, 255, 255, 0.95);
        font-weight: 600;
      }

      .icon-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        padding: 0;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.06);
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.03),
          rgba(255, 255, 255, 0.01)
        );
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .icon-btn:hover {
        color: #ff6b6b;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 107, 107, 0.2);
      }

      /* Empty state */
      .empty-state {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        text-align: center;
      }

      .empty-content h3 {
        margin: 0 0 8px 0;
        color: rgba(255, 255, 255, 0.8);
        font-size: 18px;
        font-weight: 600;
      }

      .empty-content p {
        margin: 0 0 20px 0;
        color: rgba(255, 255, 255, 0.6);
        font-size: 14px;
      }

      /* Compact Sort Control (Pattern A) Styles */
      .sort-control {
        position: relative;
        display: inline-block;
      }

      .sort-button-group {
        display: flex;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.04),
          rgba(255, 255, 255, 0.01)
        );
        backdrop-filter: blur(12px) saturate(1.1);
        -webkit-backdrop-filter: blur(12px) saturate(1.1);
        overflow: hidden;
        transition: all 0.15s ease;
      }

      .sort-button-group:hover {
        border-color: rgba(255, 255, 255, 0.12);
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.06),
          rgba(255, 255, 255, 0.02)
        );
        transform: translateY(-1px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
      }

      .sort-main-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 9px 12px;
        background: transparent;
        border: none;
        color: var(--muted);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        flex: 1;
        min-width: 120px;
        transition: color 0.15s ease;
      }

      .sort-main-btn:hover {
        color: rgba(255, 255, 255, 0.95);
      }

      .sort-label {
        color: rgba(255, 255, 255, 0.7);
        font-size: 12px;
      }

      .sort-metric {
        font-weight: 600;
      }

      .dropdown-icon {
        opacity: 0.7;
        transition: transform 0.15s ease;
      }

      .sort-main-btn[aria-expanded="true"] .dropdown-icon {
        transform: rotate(180deg);
      }

      .sort-direction-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 9px 8px;
        background: rgba(255, 255, 255, 0.02);
        border: none;
        border-left: 1px solid rgba(255, 255, 255, 0.06);
        color: var(--muted);
        cursor: pointer;
        transition: all 0.15s ease;
        width: 32px;
      }

      .sort-direction-btn:hover {
        background: rgba(255, 255, 255, 0.04);
        color: rgba(255, 255, 255, 0.95);
      }

      .direction-icon {
        opacity: 0.8;
      }

      /* Dropdown menu */
      .sort-dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1000;
        margin-top: 4px;
        padding: 8px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0.85),
          rgba(0, 0, 0, 0.95)
        );
        backdrop-filter: blur(20px) saturate(1.2);
        -webkit-backdrop-filter: blur(20px) saturate(1.2);
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.6);
        min-width: 200px;
      }

      .sort-option {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding: 10px 12px;
        border: none;
        border-radius: 6px;
        background: transparent;
        color: rgba(255, 255, 255, 0.9);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
        text-align: left;
      }

      .sort-option:hover {
        background: rgba(25, 184, 148, 0.1);
        color: #19b894;
      }

      .sort-option.active {
        background: rgba(25, 184, 148, 0.15);
        color: #19b894;
      }

      .check-icon {
        opacity: 0.8;
        color: #19b894;
      }

      /* Responsive */
      @media (max-width: 720px) {
        .cmp-header {
          flex-direction: column;
          align-items: stretch;
          gap: 12px;
        }

        .stats-summary {
          justify-content: center;
        }

        .controls {
          flex-direction: column;
          gap: 8px;
          align-items: stretch;
        }

        .controls app-country-search {
          max-width: none;
          min-width: auto;
        }

        .action-buttons {
          justify-content: center;
          flex-wrap: wrap;
          gap: 6px;
        }

        .cmp-card.centered-card {
          left: 12px;
          right: 12px;
          bottom: 24px;
          width: calc(100% - 24px);
          transform: none;
        }
      }

      .sr-only {
        position: absolute;
        left: -9999px;
        width: 1px;
        height: 1px;
        overflow: hidden;
      }

      /* Scrollbar styling */
      .glass-table-wrapper::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      .glass-table-wrapper::-webkit-scrollbar-thumb {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.08),
          rgba(255, 255, 255, 0.04)
        );
        border-radius: 4px;
        border: 1px solid rgba(255, 255, 255, 0.06);
      }

      .glass-table-wrapper {
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.08) transparent;
      }
    `,
  ],
})
export class ComparisonCard implements AfterViewInit {
  // Inject the country data service
  protected readonly countryDataService = inject(CountryDataService);

  // UI state signals
  readonly _focusedIndex = signal(0);

  readonly focusedIndex = this._focusedIndex.asReadonly();

  // Sort state signals
  readonly _sortMetric = signal<string>('none');
  readonly _sortDirection = signal<'asc' | 'desc'>('desc');
  readonly _showSortDropdown = signal<boolean>(false);

  readonly sortMetric = this._sortMetric.asReadonly();
  readonly sortDirection = this._sortDirection.asReadonly();
  readonly showSortDropdown = this._showSortDropdown.asReadonly();

  // Computed values
  readonly displayedCountries = computed(() => {
    const selectedCountries = this.countryDataService.selectedCountryData();
    const metric = this.sortMetric();
    const direction = this.sortDirection();

    return this.applySortLogic(selectedCountries, metric, direction);
  });


  // DOM refs for keyboard focus
  @ViewChildren('rowItem', { read: ElementRef }) rowItems!: QueryList<
    ElementRef<HTMLElement>
  >;

  ngAfterViewInit(): void {
    // Start with empty table - countries are added only via user interaction
    // (double-click on globe or search selection)
    this.clampFocusedIndex();
  }

  // Country selection
  selectCountry(code: string): void {
    this.countryDataService.toggleCountrySelection(code);
  }

  toggleRowSelection(index: number): void {
    const countries = this.displayedCountries();
    if (index < 0 || index >= countries.length) return;

    const country = countries[index];
    this.countryDataService.toggleCountrySelection(country.code);

    this._focusedIndex.set(index);
    this.focusRow(index);
  }

  isSelected(code: string): boolean {
    return this.countryDataService.selectedCountries().includes(code);
  }

  removeCountry(code: string): void {
    this.countryDataService.removeFromSelection([code]);
    this.clampFocusedIndex();
  }

  // Sort control methods
  toggleSortDropdown(): void {
    this._showSortDropdown.update(show => !show);
  }

  toggleSortDirection(): void {
    this._sortDirection.update(direction => direction === 'asc' ? 'desc' : 'asc');
  }

  selectSortMetric(metric: string): void {
    this._sortMetric.set(metric);
    this._showSortDropdown.set(false);
  }

  getCurrentSortLabel(): string {
    const metric = this.sortMetric();
    const direction = this.sortDirection();
    const arrow = direction === 'asc' ? '↑' : '↓';

    switch (metric) {
      case 'name': return `Country Name ${arrow}`;
      case 'hdi': return `HDI ${arrow}`;
      case 'gdp': return `GDP per Capita ${arrow}`;
      case 'population': return `Population ${arrow}`;
      case 'lifeExpectancy': return `Life Expectancy ${arrow}`;
      case 'happiness': return `Happiness Index ${arrow}`;
      default: return 'None';
    }
  }

  // Sort application logic
  private applySortLogic(countries: readonly CountryDataRecord[], metric: string, direction: 'asc' | 'desc'): readonly CountryDataRecord[] {
    if (metric === 'none') {
      return [...countries];
    }

    const ascending = direction === 'asc';

    return [...countries].sort((a, b) => {
      let valueA: number | string | null | undefined;
      let valueB: number | string | null | undefined;

      switch (metric) {
        case 'name':
          valueA = a.name;
          valueB = b.name;
          break;
        case 'gdp':
          valueA = a.gdpPerCapita;
          valueB = b.gdpPerCapita;
          break;
        case 'hdi':
          valueA = a.hdi;
          valueB = b.hdi;
          break;
        case 'population':
          valueA = a.population;
          valueB = b.population;
          break;
        case 'lifeExpectancy':
          valueA = a.lifeExpectancy;
          valueB = b.lifeExpectancy;
          break;
        case 'happiness':
          valueA = a.happiness;
          valueB = b.happiness;
          break;
        default:
          return 0;
      }

      // Handle undefined/null values - put them at the end
      if (valueA === undefined || valueA === null) {
        return valueB === undefined || valueB === null ? 0 : 1;
      }
      if (valueB === undefined || valueB === null) {
        return -1;
      }

      // String comparison for country names
      if (typeof valueA === 'string' && typeof valueB === 'string') {
        const result = valueA.localeCompare(valueB);
        return ascending ? result : -result;
      }

      // Numeric comparison
      const result = (valueA as number) - (valueB as number);
      return ascending ? result : -result;
    });
  }

  // Clear and export
  onClearAll(): void {
    this.countryDataService.clearSelection();
    this.countryDataService.clearSearch();
    this._sortMetric.set('none');
    this._sortDirection.set('desc');
    this._showSortDropdown.set(false);
    this._focusedIndex.set(0);
  }

  onExportCSV(): void {
    if (!this.countryDataService.hasSelectedCountries()) return;

    const csv = this.countryDataService.exportSelectedAsCSV();
    if (!csv) return;

    const blob = new Blob([csv], {
      type: 'text/csv;charset=utf-8;',
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `country-comparison-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // Focus and keyboard navigation
  focusRow(index: number): void {
    queueMicrotask(() => {
      const elems = this.rowItems ? this.rowItems.toArray() : [];
      if (index < 0 || index >= elems.length) return;

      const el = elems[index].nativeElement as HTMLElement | null;
      if (el && typeof el.focus === 'function') {
        el.focus();
      }
    });
  }

  private clampFocusedIndex(): void {
    const maxIndex = Math.max(0, this.displayedCountries().length - 1);
    const currentIndex = this.focusedIndex();
    if (currentIndex > maxIndex) {
      this._focusedIndex.set(maxIndex);
    }
  }

  // Track by function for ngFor
  trackByCode(_index: number, country: CountryDataRecord): string {
    return country.code;
  }
}
