<!-- Backdrop -->
<div *ngIf="isOpen()" class="modal-backdrop" [@fadeIn]>
  <!-- Modal Container -->
  <div class="modal-container" [@slideIn]>
    <!-- Prompt Step -->
    <div *ngIf="currentStep() === 'prompt'" class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ‰ {{ triggerReason() }}</h2>
        <button
          class="close-button"
          (click)="onClose()"
          aria-label="Close modal"
        >
          Ã—
        </button>
      </div>

      <div class="modal-body">
        <p class="modal-description">
          Create a free account to sync your progress across devices and never
          lose your data!
        </p>

        <!-- Stats Preview -->
        <div class="stats-preview">
          <div class="stat-item" *ngIf="statsToMigrate().gamesPlayed">
            <span class="stat-icon">ğŸ¯</span>
            <span class="stat-value">{{ statsToMigrate().gamesPlayed }}</span>
            <span class="stat-label">Games Played</span>
          </div>
          <div class="stat-item" *ngIf="statsToMigrate().countriesDiscovered">
            <span class="stat-icon">ğŸŒ</span>
            <span class="stat-value">{{
              statsToMigrate().countriesDiscovered
            }}</span>
            <span class="stat-label">Countries Discovered</span>
          </div>
          <div class="stat-item" *ngIf="statsToMigrate().achievementsUnlocked">
            <span class="stat-icon">ğŸ†</span>
            <span class="stat-value">{{
              statsToMigrate().achievementsUnlocked
            }}</span>
            <span class="stat-label">Achievements</span>
          </div>
        </div>

        <!-- Benefits List -->
        <ul class="benefits-list">
          <li>â˜ï¸ Automatic cloud backup</li>
          <li>ğŸ“Š Compete on global leaderboards</li>
          <li>ğŸ† Track achievements across devices</li>
          <li>ğŸ“± Access from anywhere</li>
        </ul>
      </div>

      <div class="modal-footer">
        <button class="button button-primary" (click)="onSignUpClick()">
          Create Free Account
        </button>
        <button class="button button-secondary" (click)="onMaybeLater()">
          Maybe Later
        </button>
      </div>
    </div>

    <!-- Sign Up Form Step -->
    <div *ngIf="currentStep() === 'signup'" class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Create Your Account</h2>
        <button
          class="close-button"
          (click)="onClose()"
          aria-label="Close modal"
        >
          Ã—
        </button>
      </div>

      <div class="modal-body">
        <!-- Error Message -->
        <div *ngIf="error()" class="error-message">
          {{ error() }}
        </div>

        <!-- Sign Up Form -->
        <form (ngSubmit)="onSubmit()" class="signup-form">
          <div class="form-group">
            <label for="email" class="form-label">Email</label>
            <input
              id="email"
              type="email"
              class="form-input"
              placeholder="your@email.com"
              [(ngModel)]="email"
              [ngModelOptions]="{ standalone: true }"
              required
              autocomplete="email"
              [disabled]="isLoading()"
            />
          </div>

          <div class="form-group">
            <label for="password" class="form-label">Password</label>
            <div class="password-input-wrapper">
              <input
                id="password"
                [type]="showPassword() ? 'text' : 'password'"
                class="form-input"
                placeholder="Create a strong password"
                [(ngModel)]="password"
                [ngModelOptions]="{ standalone: true }"
                required
                autocomplete="new-password"
                [disabled]="isLoading()"
              />
              <button
                type="button"
                class="password-toggle"
                (click)="togglePasswordVisibility()"
                [attr.aria-label]="
                  showPassword() ? 'Hide password' : 'Show password'
                "
              >
                {{ showPassword() ? "ğŸ‘ï¸" : "ğŸ‘ï¸â€ğŸ—¨ï¸" }}
              </button>
            </div>

            <!-- Password Strength Meter -->
            <div *ngIf="password()" class="password-strength-container">
              <div class="password-strength-bar">
                <div
                  class="password-strength-fill"
                  [style.width.%]="getPasswordStrengthWidth()"
                  [style.background-color]="getPasswordStrengthColor()"
                ></div>
              </div>
              <div class="password-strength-label">
                <span [style.color]="getPasswordStrengthColor()">
                  {{ passwordStrength().label }}
                </span>
              </div>
            </div>

            <!-- Password Requirements Checklist -->
            <div *ngIf="password()" class="password-requirements">
              <p class="requirements-title">Password must contain:</p>
              <ul class="requirements-list">
                <li
                  [class.valid]="hasMinLength()"
                  [class.invalid]="!hasMinLength()"
                >
                  <span class="requirement-icon">{{
                    hasMinLength() ? "âœ…" : "âŒ"
                  }}</span>
                  <span class="requirement-text">At least 8 characters</span>
                </li>
                <li
                  [class.valid]="hasUppercase()"
                  [class.invalid]="!hasUppercase()"
                >
                  <span class="requirement-icon">{{
                    hasUppercase() ? "âœ…" : "âŒ"
                  }}</span>
                  <span class="requirement-text"
                    >One uppercase letter (A-Z)</span
                  >
                </li>
                <li
                  [class.valid]="hasLowercase()"
                  [class.invalid]="!hasLowercase()"
                >
                  <span class="requirement-icon">{{
                    hasLowercase() ? "âœ…" : "âŒ"
                  }}</span>
                  <span class="requirement-text"
                    >One lowercase letter (a-z)</span
                  >
                </li>
                <li [class.valid]="hasNumber()" [class.invalid]="!hasNumber()">
                  <span class="requirement-icon">{{
                    hasNumber() ? "âœ…" : "âŒ"
                  }}</span>
                  <span class="requirement-text">One number (0-9)</span>
                </li>
                <li
                  [class.valid]="hasSpecial()"
                  [class.invalid]="!hasSpecial()"
                >
                  <span class="requirement-icon">{{
                    hasSpecial() ? "âœ…" : "âŒ"
                  }}</span>
                  <span class="requirement-text"
                    >One special character (!&#64;#$%^&*)</span
                  >
                </li>
                <li
                  [class.valid]="noCommonPatterns()"
                  [class.invalid]="!noCommonPatterns()"
                >
                  <span class="requirement-icon">{{
                    noCommonPatterns() ? "âœ…" : "âŒ"
                  }}</span>
                  <span class="requirement-text"
                    >No common patterns (password, 12345, etc.)</span
                  >
                </li>
              </ul>
            </div>
          </div>

          <div class="form-group">
            <label for="confirm-password" class="form-label"
              >Confirm Password</label
            >
            <input
              id="confirm-password"
              [type]="showPassword() ? 'text' : 'password'"
              class="form-input"
              [class.input-error]="confirmPassword() && !passwordsMatch()"
              [class.input-success]="confirmPassword() && passwordsMatch()"
              placeholder="Re-enter password"
              [(ngModel)]="confirmPassword"
              [ngModelOptions]="{ standalone: true }"
              required
              autocomplete="new-password"
              [disabled]="isLoading()"
            />
            <div
              *ngIf="confirmPassword() && !passwordsMatch()"
              class="validation-message error"
            >
              âŒ Passwords do not match
            </div>
            <div
              *ngIf="confirmPassword() && passwordsMatch()"
              class="validation-message success"
            >
              âœ… Passwords match
            </div>
          </div>

          <button
            type="submit"
            class="button button-primary button-full-width"
            [disabled]="isLoading() || !canSubmit()"
          >
            <span *ngIf="!isLoading()">Create Account</span>
            <span *ngIf="isLoading()" class="loading-spinner">Creating...</span>
          </button>
        </form>

        <!-- Divider -->
        <div class="divider">
          <span>or</span>
        </div>

        <!-- Google Sign Up -->
        <button
          type="button"
          class="button button-google button-full-width"
          (click)="onGoogleSignUp()"
          [disabled]="isLoading()"
        >
          <span class="google-icon">G</span>
          Continue with Google
        </button>

        <p class="terms-text">
          By signing up, you agree to our Terms of Service and Privacy Policy
        </p>

        <p class="switch-auth-text">
          Already have an account?
          <button
            type="button"
            class="link-button"
            (click)="switchToSignIn.emit()"
            [disabled]="isLoading()"
          >
            Sign in
          </button>
        </p>
      </div>
    </div>

    <!-- Migrating Step -->
    <div *ngIf="currentStep() === 'migrating'" class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">âœ¨ Syncing Your Progress</h2>
      </div>

      <div class="modal-body">
        <div class="migration-status">
          <div class="loading-spinner-large">â³</div>
          <p class="migration-message">
            We're securely transferring your local progress to the cloud...
          </p>
          <div class="migration-progress">
            <div class="progress-bar">
              <div class="progress-fill"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Email Confirmation Step -->
    <div *ngIf="currentStep() === 'email-confirmation'" class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“§ Check Your Email</h2>
        <button
          class="close-button"
          (click)="onClose()"
          aria-label="Close modal"
        >
          Ã—
        </button>
      </div>

      <div class="modal-body">
        <p class="modal-description">
          We've sent a confirmation email to <strong>{{ email() }}</strong
          >.
        </p>
        <p class="modal-description">
          Please check your inbox and click the confirmation link to activate
          your account and sync your progress.
        </p>

        <div class="email-confirmation-notice">
          <p>âœ… Your account has been created</p>
          <p>ğŸ“§ Confirmation email sent</p>
          <p>ğŸ”’ Your local data is safe and will sync after confirmation</p>
        </div>
      </div>

      <div class="modal-footer">
        <button
          type="button"
          class="button button-primary button-full-width"
          (click)="onClose()"
        >
          Got it!
        </button>
      </div>
    </div>
  </div>
</div>
